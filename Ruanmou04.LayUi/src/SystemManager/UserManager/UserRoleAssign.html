<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title></title>
  <link href="/css/layui.css" rel="stylesheet" />
</head>

<body>
  <div class="layui-form layui-form-pane1" action="" lay-filter="first">
    <div class="layui-form-item">
      <label class="layui-form-label"></label>
      <div class="layui-input-inline">
        <input type="hidden" name="userId" id="userId">
      </div>
    </div>
    <div class="layui-form-item">
      <label class="layui-form-label">姓名</label>
      <div class="layui-input-inline">
        <input type="text" id="Name" name="Name" readonly autocomplete="off" class="layui-input">
      </div>
    </div>
    <div class="layui-form-item">
      <label class="layui-form-label">账号</label>
      <div class="layui-input-inline">
        <input type="text" id="Account" name="Account" readonly autocomplete="off" class="layui-input">
      </div>
    </div>
    <div class="layui-form-item" pane>
      <label class="layui-form-label">角色</label>
      <div class="layui-input-block" id="userRole">
      </div>
    </div>
    <div class="layui-form-item">
      <div class="layui-input-block">
        <button class="layui-btn" lay-submit lay-filter="sub">立即提交</button>
        <button onclick="parent.layer.closeAll()" class="layui-btn layui-btn-primary">关闭</button>
      </div>
    </div>
  </div>
  <script id="tepMenue" type="text/html">
    {{# layui.each(d,function(index,item){ }}
    <input type="checkbox" name="roleIds" value="{{item.Id}}" title="{{item.Text}}"> {{# }); }}
  </script>
  <script src="/layui.js"></script>
  <script src="/common.js"></script>
  <script type="text/javascript">
    var userDetail = {
      userInitCallBack: function (data) {
        var form = global.form, $ = global.$;
        if (parent.layer.data) {
          $("#userId").val(parent.layer.data.Id);
          $("#Name").val(parent.layer.data.Name);
          $("#Account").val(parent.layer.data.Account);
        }
        var laytpl = layui.laytpl;
        var getTpl = document.getElementById('tepMenue').innerHTML;
        var view = document.getElementById('userRole');
        laytpl(getTpl).render(data, function (html) {
          view.innerHTML = html;
          form.render();
        });
        userDetail.selectRole();
      },

      userInIt: function () {
        LoadData('/Role/GetUserSetRoles', null, userDetail.userInitCallBack);
      },

      selectRoleCallBack: function (data) {
        var $ = global.$, form = global.form;
        var unitTypeCheckbox = $("input[name='roleIds']");
        for (var j = 0; j < data.length; j++) {
          for (var i = 0; i < unitTypeCheckbox.length; i++) {
            if (unitTypeCheckbox[i].value == data[j].SysRoleId) {
              unitTypeCheckbox[i].checked = true;
            }
          }
        }
        form.render("checkbox");
      },

      selectRole: function () {
        var data = { userId: parent.layer.data.Id };
        LoadData('/RoleUser/GetUserRoleByUserID', data, userDetail.selectRoleCallBack);
      },

      saveUser: function (saveData) {
        var $=global.$;
        var user = saveData;
        var userId = saveData.userId ? parseInt(saveData.userId) : 0;
        var result = [];
        $("[name='roleIds']:checkbox").each(function () {
          if ($(this).is(":checked")) {
            result.push($(this).attr("value"));
          }
        });
        var roleIds = result.join(",");
        var data = { userId: userId, roleIds: roleIds };
        saveDataWay(data, '/UserRole/SaveData', 'Get');
        return false;
      },
    }
    layui.use(["form", "config", 'laytpl'], function () {
      var form = layui.form,
        layer = layui.layer,
        $ = layui.$,
        config = layui.config;

      initJs(layui);

      userDetail.userInIt();
      form.on("submit(sub)", function (obj) {
        userDetail.saveUser(obj.field);
      })
    })
  </script>
</body>

</html>